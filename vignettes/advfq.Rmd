---
title: "Creating ADVFQ"
output:
  rmarkdown::html_vignette:
vignette: >
  %\VignetteIndexEntry{Creating ADVFQ}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
  
```{r setup, include = FALSE}
knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>"
)
```

# Introduction

This article describes creating an ADVFQ ADaM with Visual Functioning Questionnaire
data for ophthalmology endpoints. It is to be used in conjunction with the article on [creating a BDS dataset from SDTM](https://pharmaverse.github.io/admiral/articles/bds_finding.html). As such, derivations and processes that are not specific to ADVFQ are absent, and the user is invited to consult the aforementioned article for guidance.

**Note**: *All examples assume CDISC SDTM and/or ADaM format as input unless
otherwise specified.* 

The full, open-source VFQ questionnaire can be accessed [here](https://www.nei.nih.gov/learn-about-eye-health/outreach-resources/outreach-materials/visual-function-questionnaire-25).

## Dataset Contents

`{admiralophtha}` suggests to populate ADVFQ solely with VFQ-related records. Any other questionnaire data should be placed in separate datasets (e.g. ADQS).

The records in ADVFQ can be categorized in four groups:

1. The __original__/__raw__ records coming from VFQ itself. Not all of these items are measured on the same scale.
1. The __transformed__ records, which are in a one-to-one correspondence with the original records and serve the recode the latter on the same 0 - 100 scale.
1. The __composite scores by category__, which are means of all the transformed records from within a category, e.g. "Near activities score".
1. The __overall composite scores__, which are means of all the transformed records from within combined groups of categories.

## Required Packages

The examples of this vignette require the following packages.

```{r, warning=FALSE, message=FALSE}
library(dplyr)
library(admiral)
library(pharmaversesdtm)
library(admiraldev)
library(admiralophtha)
library(stringr)
```

# Programming Workflow

* [Reading in data and setting up lookup tables](#setup_lookup)
* [Initial set up and mapping the raw records](#mapping_raw)
* [Deriving the transformed records](#deriving_transformed) 
* [Deriving the composite parameters](#deriving_composite)
* [Final steps](#final_steps) 
* [Example Script](#example) 

## Reading in data and setting up lookup tables {#setup_lookup}

To start, all datasets needed for the creation of the VFQ analysis dataset
should be read into the environment. For the purpose of demonstration we shall use the `{pharmaversesdtm}` `qs_ophtha` and {admiral} ADSL test datasets. Note that the former only contains VFQ records.

```{r} 
data("admiral_adsl")
data("qs_ophtha")

adsl <- admiral_adsl
qs <- qs_ophtha
```

Next, it will prove useful to set up lookup tables ahead of time for the `PARAM`/`PARAMCD` and `PARCATx` variables for the original, transformed and composite parameters. This is so that when the latter two are derived later in the script, we can simply assign `PARAMCD` and then perform a merge (by `PARAMCD`) with the lookup tables to associate to them the `PARAM` and the `PARCATx` variables as well.

For convenience, we set up three separate lookup tables. You can peruse how the tables are structured below - for the full set up code, please visit the [ad_advfq.R](https://github.com/pharmaverse/admiralophtha/blob/main/inst/templates/ad_advfq.R) template.

```{r, eval=TRUE, echo=FALSE} 
## Original parameters (note PARAM, PARAMCD are identical to QSTEST, QSTESTCD) ----
param_lookup_original <- tribble(
  ~QSTESTCD, ~QSTEST, ~PARCAT3, ~PARCAT4, ~PARCAT5,
  "VFQ101", "Your Overall Health Is", "general health", "General Health", "Base Item",
  "VFQ102", "Eyesight Using Both Eyes Is", "general vision", "General Vision", "Base Item",
  "VFQ103", "How Often You Worry About Eyesight", "well-being/distress", "Vision Specific: Mental Health", "Base Item",
  "VFQ104", "How Much Pain in and Around Eyes", "ocular pain", "Ocular Pain", "Base Item",
  "VFQ105", "Difficulty Reading Newspapers", "near vision", "Near Activities", "Base Item",
  "VFQ106", "Difficulty Doing Work/Hobbies", "near vision", "Near Activities", "Base Item",
  "VFQ107", "Difficulty Finding on Crowded Shelf", "near vision", "Near Activities", "Base Item",
  "VFQ108", "Difficulty Reading Street Signs", "distance vision", "Distance Activities", "Base Item",
  "VFQ109", "Difficulty Going Down Step at Night", "distance vision", "Distance Activities", "Base Item",
  "VFQ110", "Difficulty Noticing Objects to Side", "peripheral vision", "Peripheral Vision", "Base Item",
  "VFQ111", "Difficulty Seeing How People React", "social fx", "Vision Specific: Social Functioning", "Base Item",
  "VFQ112", "Difficulty Picking Out Own Clothes", "color vision", "Color Vision", "Base Item",
  "VFQ113", "Difficulty Visiting With People", "social fx", "Vision Specific: Social Functioning", "Base Item",
  "VFQ114", "Difficulty Going Out to See Movies", "distance vision", "Distance Activities", "Base Item",
  "VFQ115", "Are You Currently Driving", "driving (filter item)", NA_character_, "Base Item",
  "VFQ115A", "Never Driven or Given Up Driving", "driving (filter item)", NA_character_, "Base Item",
  "VFQ115B", "Main Reason You Gave Up Driving", "driving (filter item)", NA_character_, "Base Item",
  "VFQ115C", "Difficulty Driving During Daytime", "driving", "Driving", "Base Item",
  "VFQ116", "Difficulty Driving at Night", "driving", "Driving", "Base Item",
  "VFQ116A", "Driving in Difficult Conditions", "driving", "Driving", "Base Item",
  "VFQ117", "Accomplish Less Than You Would Like", "role limitations", "Vision Specific: Role Difficulties", "Base Item",
  "VFQ118", "Limited in How Long You Can Work", "role limitations", "Vision Specific: Role Difficulties", "Base Item",
  "VFQ119", "Eye Pain Keep From Doing What Like", "ocular pain", "Ocular Pain", "Base Item",
  "VFQ120", "I Stay Home Most of the Time", "dependency", "Vision Specific: Dependency", "Base Item",
  "VFQ121", "I Feel Frustrated a Lot of the Time", "well-being/distress", "Vision Specific: Mental Health", "Base Item",
  "VFQ122", "Much Less Control Over What I Do", "well-being/distress", "Vision Specific: Mental Health", "Base Item",
  "VFQ123", "Rely Too Much on What Others Tell", "dependency", "Vision Specific: Dependency", "Base Item",
  "VFQ124", "I Need a Lot of Help From Others", "dependency", "Vision Specific: Dependency", "Base Item",
  "VFQ125", "Worry I'll Do Embarrassing Things", "well-being/distress", "Vision Specific: Mental Health", "Base Item",
  "VFQ1A01", "Rate Your Overall Health", "general health", "General Health", "Optional Item",
  "VFQ1A02", "Rate Your Eyesight Now", "general vision", "General Vision", "Optional Item",
  "VFQ1A03", "Difficulty Reading Small Print", "near vision", "Near Activities", "Optional Item",
  "VFQ1A04", "Difficulty Figure Out Bill Accuracy", "near vision", "Near Activities", "Optional Item",
  "VFQ1A05", "Difficulty Shaving or Styling Hair", "near vision", "Near Activities", "Optional Item",
  "VFQ1A06", "Difficulty Recognizing People", "distance vision", "Distance Activities", "Optional Item",
  "VFQ1A07", "Difficulty Taking Part in Sports", "distance vision", "Distance Activities", "Optional Item",
  "VFQ1A08", "Difficulty Seeing Programs on TV", "distance vision", "Distance Activities", "Optional Item",
  "VFQ1A09", "Difficulty Entertaining Friends", "social fx", "Vision Specific: Social Functioning", "Optional Item",
  "VFQ1A11A", "Do You Have More Help From Others", "role limitations", "Vision Specific: Role Difficulties", "Optional Item",
  "VFQ1A11B", "Limited in Kinds of Things Can Do", "role limitations", "Vision Specific: Role Difficulties", "Optional Item",
  "VFQ1A12", "Often Irritable Because Eyesight", "well-being/distress", "Vision Specific: Mental Health", "Optional Item",
  "VFQ1A13", "I Don't Go Out of My Home Alone", "dependency", "Vision Specific: Dependency", "Optional Item"
) %>%
  mutate(
    PARAMCD = QSTESTCD,
    PARAM = str_remove(QSTEST, "VFQ1-"),
    PARCAT1 = "VFQ-25 INTERVIEWER ADMINISTERED",
    PARCAT2 = "Original Items"
  ) %>% 
  select(QSTESTCD, QSTEST, PARAM, PARAMCD, PARCAT1, PARCAT2, PARCAT3, PARCAT4, PARCAT5)

## Transformed parameters ----
param_lookup_transformed <- tribble(
  ~PARAMCD, ~PARAM, ~PARCAT3, ~PARCAT4, ~PARCAT5,
  "QR01", "Transformed - Your Overall Health Is", "general health", "General Health", "Base Item",
  "QR02", "Transformed - Eyesight Using Both Eyes Is", "general vision", "General Vision", "Base Item",
  "QR03", "Transformed - How Often You Worry About Eyesight", "well-being/distress", "Vision Specific: Mental Health", "Base Item",
  "QR04", "Transformed - How Much Pain in and Around Eyes", "ocular pain", "Ocular Pain", "Base Item",
  "QR05", "Transformed - Difficulty Reading Newspapers", "near vision", "Near Activities", "Base Item",
  "QR06", "Transformed - Difficulty Doing Work/Hobbies", "near vision", "Near Activities", "Base Item",
  "QR07", "Transformed - Difficulty Finding on Crowded Shelf", "near vision", "Near Activities", "Base Item",
  "QR08", "Transformed - Difficulty Reading Street Signs", "distance vision", "Distance Activities", "Base Item",
  "QR09", "Transformed - Difficulty Going Down Step at Night", "distance vision", "Distance Activities", "Base Item",
  "QR10", "Transformed - Difficulty Noticing Objects to Side", "peripheral vision", "Peripheral Vision", "Base Item",
  "QR11", "Transformed - Difficulty Seeing How People React", "social fx", "Vision Specific: Social Functioning", "Base Item",
  "QR12", "Transformed - Difficulty Picking Out Own Clothes", "color vision", "Color Vision", "Base Item",
  "QR13", "Transformed - Difficulty Visiting With People", "social fx", "Vision Specific: Social Functioning", "Base Item",
  "QR14", "Transformed - Difficulty Going Out to See Movies", "distance vision", "Distance Activities", "Base Item",
  "QR15C", "Transformed - Main Reason You Gave Up Driving", "driving", "Driving", "Base Item",
  "QR16", "Transformed - Difficulty Driving at Night", "driving", "Driving", "Base Item",
  "QR16A", "Transformed - Driving in Difficult Conditions", "driving", "Driving", "Base Item",
  "QR17", "Transformed - Accomplish Less Than You Would Like", "role limitations", "Vision Specific: Role Difficulties", "Base Item",
  "QR18", "Transformed - Limited in How Long You Can Work", "role limitations", "Vision Specific: Role Difficulties", "Base Item",
  "QR19", "Transformed - Eye Pain Keep From Doing What Like", "ocular pain", "Ocular Pain", "Base Item",
  "QR20", "Transformed - I Stay Home Most of the Time", "dependency", "Vision Specific: Dependency", "Base Item",
  "QR21", "Transformed - I Feel Frustrated a Lot of the Time", "well-being/distress", "Vision Specific: Mental Health", "Base Item",
  "QR22", "Transformed - Much Less Control Over What I Do", "well-being/distress", "Vision Specific: Mental Health", "Base Item",
  "QR23", "Transformed - Rely Too Much on What Others Tell", "dependency", "Vision Specific: Dependency", "Base Item",
  "QR24", "Transformed - I Need a Lot of Help From Others", "dependency", "Vision Specific: Dependency", "Base Item",
  "QR25", "Transformed - Worry I'll Do Embarrassing Things", "well-being/distress", "Vision Specific: Mental Health", "Base Item",
  "QRA01", "Transformed - Rate Your Overall Health", "general health", "General Health", "Optional Item",
  "QRA02", "Transformed - Rate Your Eyesight Now", "general vision", "General Vision", "Optional Item",
  "QRA03", "Transformed - Difficulty Reading Small Print", "near vision", "Near Activities", "Optional Item",
  "QRA04", "Transformed - Difficulty Figure Out Bill Accuracy", "near vision", "Near Activities", "Optional Item",
  "QRA05", "Transformed - Difficulty Shaving or Styling Hair", "near vision", "Near Activities", "Optional Item",
  "QRA06", "Transformed - Difficulty Recognizing People", "distance vision", "Distance Activities", "Optional Item",
  "QRA07", "Transformed - Difficulty Taking Part in Sports", "distance vision", "Distance Activities", "Optional Item",
  "QRA08", "Transformed - Difficulty Seeing Programs on TV", "distance vision", "Distance Activities", "Optional Item",
  "QRA09", "Transformed - Difficulty Entertaining Friends", "social fx", "Vision Specific: Social Functioning", "Optional Item",
  "QR1A11A", "Transformed - Do You Have More Help From Others", "role limitations", "Vision Specific: Role Difficulties", "Optional Item",
  "QR1A11B", "Transformed - Limited in Kinds of Things Can Do", "role limitations", "Vision Specific: Role Difficulties", "Optional Item",
  "QR1A12", "Transformed - Often Irritable Because Eyesight", "well-being/distress", "Vision Specific: Mental Health", "Optional Item",
  "QR1A13", "Transformed - I Don't Go Out of My Home Alone", "dependency", "Vision Specific: Dependency", "Optional Item"
) %>%
  mutate(
    PARCAT1 = "VFQ-25 INTERVIEWER ADMINISTERED",
    PARCAT2 = "Transformed - Original Items"
  ) %>% 
  select(PARAM, PARAMCD, PARCAT1, PARCAT2, PARCAT3, PARCAT4, PARCAT5)

## Composite parameters ----
param_lookup_composite <- tribble(
  ~PARAMCD,   ~PARAM,                                                             ~PARCAT3,      ~PARCAT4,                              ~PARCAT5,
  "QSBGH",    "General Health Score",                                             NA_character_, "General Health",                      "VFQ-25",
  "QSBGV",    "General Vision Score",                                             NA_character_, "General Vision",                      "VFQ-25",
  "QSBNA",    "Near Activities Score",                                            NA_character_, "Near Activities",                     "VFQ-25",
  "QSBDA",    "Distance Activities Score",                                        NA_character_, "Distance Activities",                 "VFQ-25",
  "QSBSF",    "Vision Specific: Social Functioning Score",                        NA_character_, "Vision Specific: Social Functioning", "VFQ-25",
  "QSBCV",    "Color Vision Score",                                               NA_character_, "Color Vision",                        "VFQ-25",
  "QSBPV",    "Peripheral Vision Score",                                          NA_character_, "Peripheral Vision",                   "VFQ-25",
  "QSBDR",    "Driving Score",                                                    NA_character_, "Driving",                             "VFQ-25",
  "QSBRD",    "Vision Specific: Role Difficulties Score",                         NA_character_, "Vision Specific: Role Difficulties",  "VFQ-25",
  "QSBOP",    "Ocular Pain Score",                                                NA_character_, "Ocular Pain",                         "VFQ-25",
  "QSBDP",    "Vision Specific: Dependency Score",                                NA_character_, "Vision Specific: Dependency",         "VFQ-25",
  "QSBMH",    "Vision Specific: Mental Health Score",                             NA_character_, "Vision Specific: Mental Health",      "VFQ-25",
  "QSOGH",    "General Health Score (incl. Optional Items)",                      NA_character_, "General Health",                      "VFQ-39",
  "QSOGV",    "General Vision Score (incl. Optional Items)",                      NA_character_, "General Vision",                      "VFQ-39",
  "QSONA",    "Near Activities Score (incl. Optional Items)",                     NA_character_, "Near Activities",                     "VFQ-39",
  "QSODA",    "Distance Activities Score (incl. Optional Items)",                 NA_character_, "Distance Activities",                 "VFQ-39",
  "QSOSF",    "Vision Specific: Social Functioning Score (incl. Optional Items)", NA_character_, "Vision Specific: Social Functioning", "VFQ-39",
  "QSOCV",    "Color Vision Score (incl. Optional Items)",                        NA_character_, "Color Vision",                        "VFQ-39",
  "QSOPV",    "Peripheral Vision Score (incl. Optional Items)",                   NA_character_, "Peripheral Vision",                   "VFQ-39",
  "QSODR",    "Driving Score (incl. Optional Items)",                             NA_character_, "Driving",                             "VFQ-39",
  "QSORD",    "Vision Specific: Role Difficulties Score (incl. Optional Items)",  NA_character_, "Vision Specific: Role Difficulties",  "VFQ-39",
  "QSOOP",    "Ocular Pain Score (incl. Optional Items)",                         NA_character_, "Ocular Pain",                         "VFQ-39",
  "QSODP",    "Vision Specific: Dependency Score (incl. Optional Items)",         NA_character_, "Vision Specific: Dependency",         "VFQ-39",
  "QSOMH",    "Vision Specific: Mental Health Score (incl. Optional Items)",      NA_character_, "Vision Specific: Mental Health",      "VFQ-39",
  "QBCSCORE", "Composite Score",                                                  NA_character_, "Composite Score",                     "VFQ-25",
  "QOCSCORE", "Composite Score (incl. Optional Items)",                           NA_character_, "Composite Score",                     "VFQ-39"
) %>%
  mutate(
    PARCAT1 = "VFQ-25 INTERVIEWER ADMINISTERED",
    PARCAT2 = "Derived Scale"
  ) %>% 
  select(PARAM, PARAMCD, PARCAT1, PARCAT2, PARCAT3, PARCAT4, PARCAT5)
```

#### Original items

```{r, eval=TRUE, echo=FALSE}
dataset_vignette(
  param_lookup_original,
  display_vars = exprs(QSTESTCD, QSTEST, PARAM, PARAMCD, PARCAT1, PARCAT2, PARCAT3, PARCAT4, PARCAT5)
) 
```

#### Transformed records

```{r, eval=TRUE, echo=FALSE}
dataset_vignette(
  param_lookup_transformed,
  display_vars = exprs(PARAM, PARAMCD, PARCAT1, PARCAT2, PARCAT3, PARCAT4, PARCAT5)
)
```

#### Composite records

```{r, eval=TRUE, echo=FALSE}
dataset_vignette(
  param_lookup_composite,
  display_vars = exprs(PARAM, PARAMCD, PARCAT1, PARCAT2, PARCAT3, PARCAT4, PARCAT5)
)
```
## Initial set up and mapping the raw recordsQ {#mapping_raw} 

We can now start setting up ADVFQ by taking `qs` and merging on some ADSL variables which are needed for BDS derivations later down the line. Note that there is no need to merge on the whole ADSL dataset immediately as in so doing we would be needlessly increasing the size of the working dataset; the rest of the variables will be merged on at the end. 

```{r, eval = TRUE}
adsl_vars <- exprs(TRTSDT, TRTEDT, TRT01A, TRT01P)

advfq <- qs %>%
  ## merge on ADSL vars ----
derive_vars_merged(
  dataset_add = adsl,
  new_vars = adsl_vars,
  by_vars = get_admiral_option("subject_keys")
)
```

Now we can derive the analysis date (`ADT`) and analysis relative day (`ADY`) variables. These derivations are study-specific and so the ones below are just samples - the user is again invited to consult the vignette on [creating a BDS dataset from SDTM](https://pharmaverse.github.io/admiral/articles/bds_finding.html) for details on this topic.

```{r, eval = TRUE}
advfq <- advfq %>%
  ## analysis dates ADT, ADY ----
derive_vars_dt(
  new_vars_prefix = "A",
  dtc = QSDTC
) %>%
  derive_vars_dy(
    reference_date = TRTSDT,
    source_vars = exprs(ADT)
  )
```

Next, we can assign `PARAMCD` for the original parameters by merging with the `param_lookup_original` table we set up earlier. Using `derive_vars_merged_lookup()` allows us to get console-level feedback that all the `QSTESTCD`s have been mapped. We only add `PARAMCD` for now, and will derive `PARCATx` and `PARAM` later - again to avoid carrying forward too many variables. 

We can also derive `AVAL`, `AVALC` and `BASETYPE` for the original records with a simple `mutate()` statement, and then `AVISIT` and `AVISITN` with study-specific logic.

```{r, eval = TRUE}
advfq <- advfq %>%
  ## Add PARAMCD for original parameters only - PARCATx and PARAM will be added later ----
  derive_vars_merged_lookup(
    dataset_add = param_lookup_original,
    new_vars = exprs(PARAMCD),
    by_vars = exprs(QSTESTCD)
  ) %>%
  ## Calculate AVAL and AVALC and derive BASETYPE ----
  mutate(
    AVAL = QSSTRESN,
    AVALC = QSORRES,
    BASETYPE = "LAST PERIOD 01"
  ) %>%
  # Derive Visits ----
  mutate(
    AVISIT = case_when(
      str_detect(VISIT, "DAY 1") ~ "Baseline",
      !is.na(VISIT) ~ str_to_title(VISIT),
      TRUE ~ NA_character_
    ),
    AVISITN = case_when(
      VISIT == "BASELINE" ~ "0",
      str_detect(VISIT, "WEEK") ~ VISIT %>%
        str_replace("WEEK", "") %>%
        str_trim(),
      TRUE ~ NA
    ),
  )
```

Here's what the data for the "Near Activities" and "Distance Activities" quesitons looks like for one patient's first to visits:

```{r, eval=TRUE, echo=FALSE}
dataset_vignette(
  advfq %>% 
    filter(USUBJID %in% c("01-701-1034"), PARAMCD %in% c("VFQ105", "VFQ106", "VFQ107", "VFQ108", "VFQ109")) %>% 
    arrange(USUBJID, AVISITN, PARAMCD),
  display_vars = exprs(USUBJID, QSTEST, AVISIT, PARAMCD, AVAL, AVALC)
)
```

## Deriving the transformed records {#deriving_transformed}

Now we are ready to derive the transformed records. Excluding 15C (see later down this section), all of these are derived by re-scaling a single original record. As such, the prototypical code which can be used to derive them is a call to `derive_summary_records()` which is structured as follows:

```{r, eval = FALSE}
derive_summary_records(
  dataset = advfq,
  dataset_add = advfq,
  by_vars = c(
    get_admiral_option("subject_keys"),
    exprs(!!!adsl_vars, PARAMCD, AVISIT, AVISITN, ADT, ADY)
  ),
  filter_add = QSTESTCD == "<some parameter>" & !is.na(AVAL),
  set_values_to = exprs(
    AVAL = compute_scale(
      source = AVAL, 
      source_range = <some source range>, 
      target_range = c(0, 100), 
      flip_direction = <TRUE or FALSE>
    ),
    PARAMCD = "QR01"
  )
)
```

The function `compute_scale()` is a helper function from `{admiral}` which performs the re-scaling. The user will need to specify the `source_range` (i.e. the range of possible values for the original record) and whether or not to `flip_direction` (i.e. whether higher values of the original record correspond to better or worse outcomes). Note that both the `source_range` and `flip_direction` *will* change across parameters - for instance, the source range is `c(1,5)` for `PARAMCD == "VFQ101"` but `c(1,36)` for `PARAMCD == "VFQ102"`.

For question 15C we have to be a little more careful as the derivation depends on whether or not question 15C was asked at that visit. If it was, then we can derive the transformed record as normal. However, if it wasn't, then we have to check the response to question 15B - if the response to 15B indicates that the patient has never driven or given up driving (i.e. `QSTRESN == 1`), then we set the transformed record to 0; otherwise, we do not derive a transformed record for that visit. To do this, we can set up a temporary flag variable using `derive_var_merged_exist_flag()` to identify visits where question 15C was not asked, and then use that flag in the derivation of the transformed record for 15C.

```{r, eval = TRUE}
advfq <- advfq %>%
  # Set up temporary flag to be used for QR15C derivation later. The flag identifies
  # visits where QSTESTCD == "VFQ115C" does not exist, for which a different derivation
  # of QR15C is required
  derive_var_merged_exist_flag(
    dataset_add = advfq,
    by_vars = exprs(!!!adsl_vars, ADT, ADY),
    new_var = TEMP_VFQ115C_FL,
    condition = QSTESTCD == "VFQ115C",
    true_value = "Y",
    false_value = "N",
    missing_value = "M"
  )
```

We can then derive the transformed records, including the special handling for 15C, in a single call to `call_derivation()`, since each call to `derive_summary_records()` contains the same assignment of `dataset`, `dataset_add` and `by_vars` and then only differs in the `filter_add` and `set_values_to` arguments. Here is a shortened version of this call, including only a select few parameters. For the full call, please see the [ad_advfq.R](https://github.com/pharmaverse/admiralophtha/blob/main/inst/templates/ad_advfq.R) template.

```{r, eval = FALSE}
advfq <- advfq %>%
  call_derivation(
    derivation = derive_summary_records,
    dataset = .,
    dataset_add = .,
    by_vars = c(
      get_admiral_option("subject_keys"),
      exprs(!!!adsl_vars, PARAMCD, AVISIT, AVISITN, ADT, ADY)
    ),
    variable_params = list(
      params(
        filter_add = QSTESTCD == "VFQ101" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(
            source = AVAL, 
            source_range = c(1, 5), 
            target_range = c(0, 100), 
            flip_direction = TRUE
          ),
          PARAMCD = "QR01"
        )
      ),
      params(
        filter_add = QSTESTCD == "VFQ102" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(
            source = AVAL, 
            source_range = c(1, 6), 
            target_range = c(0, 100), 
            flip_direction = TRUE
          ),
          PARAMCD = "QR02"
        )
      ),
      # For QR15C, do it in two parts
      # first in the case where QSTESTCD == "VFQ115C" is present at that visit
      params(
        filter_add = QSTESTCD == "VFQ115C" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(
            source = AVAL, 
            source_range = c(1, 5), 
            target_range = c(0, 100), 
            flip_direction = TRUE
          ),
          PARAMCD = "QR15C"
        )
      ),
      # second in the case where QSTESTCD == "VFQ115C" is not present at that visit
      params(
        filter_add = TEMP_VFQ115C_FL == "N" & QSTESTCD == "VFQ115B" & AVAL == 1,
        set_values_to = exprs(
          AVAL = 0,
          PARAMCD = "QR15C"
        )
      ),
      params(
        filter_add = QSTESTCD == "VFQ119" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(
            source = AVAL, 
            source_range = c(1, 5), 
            target_range = c(0, 100), 
            flip_direction = FALSE
          ),
          PARAMCD = "QR19"
        )
      )
    )
  )
```

```{r, eval = TRUE, include = FALSE}
advfq <- advfq %>%
  call_derivation(
    derivation = derive_summary_records,
    dataset = .,
    dataset_add = .,
    by_vars = c(
      get_admiral_option("subject_keys"),
      exprs(!!!adsl_vars, PARAMCD, AVISIT, AVISITN, ADT, ADY)
    ),
    variable_params = list(
      params(
        filter_add = QSTESTCD == "VFQ101" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(source = AVAL, source_range = c(1, 5), target_range = c(0, 100), flip_direction = TRUE),
          PARAMCD = "QR01"
        )
      ),
      params(
        filter_add = QSTESTCD == "VFQ102" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(source = AVAL, source_range = c(1, 6), target_range = c(0, 100), flip_direction = TRUE),
          PARAMCD = "QR02"
        )
      ),
      params(
        filter_add = QSTESTCD == "VFQ103" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(source = AVAL, source_range = c(1, 5), target_range = c(0, 100), flip_direction = TRUE),
          PARAMCD = "QR03"
        )
      ),
      params(
        filter_add = QSTESTCD == "VFQ104" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(source = AVAL, source_range = c(1, 5), target_range = c(0, 100), flip_direction = TRUE),
          PARAMCD = "QR04"
        )
      ),
      params(
        filter_add = QSTESTCD == "VFQ105" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(source = AVAL, source_range = c(1, 5), target_range = c(0, 100), flip_direction = TRUE),
          PARAMCD = "QR05"
        )
      ),
      params(
        filter_add = QSTESTCD == "VFQ106" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(source = AVAL, source_range = c(1, 5), target_range = c(0, 100), flip_direction = TRUE),
          PARAMCD = "QR06"
        )
      ),
      params(
        filter_add = QSTESTCD == "VFQ107" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(source = AVAL, source_range = c(1, 5), target_range = c(0, 100), flip_direction = TRUE),
          PARAMCD = "QR07"
        )
      ),
      params(
        filter_add = QSTESTCD == "VFQ108" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(source = AVAL, source_range = c(1, 5), target_range = c(0, 100), flip_direction = TRUE),
          PARAMCD = "QR08"
        )
      ),
      params(
        filter_add = QSTESTCD == "VFQ109" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(source = AVAL, source_range = c(1, 5), target_range = c(0, 100), flip_direction = TRUE),
          PARAMCD = "QR09"
        )
      ),
      params(
        filter_add = QSTESTCD == "VFQ110" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(source = AVAL, source_range = c(1, 5), target_range = c(0, 100), flip_direction = TRUE),
          PARAMCD = "QR10"
        )
      ),
      params(
        filter_add = QSTESTCD == "VFQ111" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(source = AVAL, source_range = c(1, 5), target_range = c(0, 100), flip_direction = TRUE),
          PARAMCD = "QR11"
        )
      ),
      params(
        filter_add = QSTESTCD == "VFQ112" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(source = AVAL, source_range = c(1, 5), target_range = c(0, 100), flip_direction = TRUE),
          PARAMCD = "QR12"
        )
      ),
      params(
        filter_add = QSTESTCD == "VFQ113" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(source = AVAL, source_range = c(1, 5), target_range = c(0, 100), flip_direction = TRUE),
          PARAMCD = "QR13"
        )
      ),
      params(
        filter_add = QSTESTCD == "VFQ114" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(source = AVAL, source_range = c(1, 5), target_range = c(0, 100), flip_direction = TRUE),
          PARAMCD = "QR14"
        )
      ),
      # For QR15C, do it in two parts
      # first in the case where QSTESTCD == "VFQ115C" is present at that visit
      params(
        filter_add = QSTESTCD == "VFQ115C" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(source = AVAL, source_range = c(1, 5), target_range = c(0, 100), flip_direction = TRUE),
          PARAMCD = "QR15C"
        )
      ),
      # second in the case where QSTESTCD == "VFQ115C" is not present at that visit
      params(
        filter_add = TEMP_VFQ115C_FL == "N" & QSTESTCD == "VFQ115B" & AVAL == 1,
        set_values_to = exprs(
          AVAL = 0,
          PARAMCD = "QR15C"
        )
      ),
      params(
        filter_add = QSTESTCD == "VFQ116" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(source = AVAL, source_range = c(1, 5), target_range = c(0, 100), flip_direction = TRUE),
          PARAMCD = "QR16"
        )
      ),
      params(
        filter_add = QSTESTCD == "VFQ116A" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(source = AVAL, source_range = c(1, 5), target_range = c(0, 100), flip_direction = TRUE),
          PARAMCD = "QR16A"
        )
      ),
      params(
        filter_add = QSTESTCD == "VFQ117" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(source = AVAL, source_range = c(1, 5), target_range = c(0, 100), flip_direction = FALSE),
          PARAMCD = "QR17"
        )
      ),
      params(
        filter_add = QSTESTCD == "VFQ118" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(source = AVAL, source_range = c(1, 5), target_range = c(0, 100), flip_direction = FALSE),
          PARAMCD = "QR18"
        )
      ),
      params(
        filter_add = QSTESTCD == "VFQ119" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(source = AVAL, source_range = c(1, 5), target_range = c(0, 100), flip_direction = FALSE),
          PARAMCD = "QR19"
        )
      ),
      params(
        filter_add = QSTESTCD == "VFQ120" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(source = AVAL, source_range = c(1, 5), target_range = c(0, 100), flip_direction = FALSE),
          PARAMCD = "QR20"
        )
      ),
      params(
        filter_add = QSTESTCD == "VFQ121" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(source = AVAL, source_range = c(1, 5), target_range = c(0, 100), flip_direction = FALSE),
          PARAMCD = "QR21"
        )
      ),
      params(
        filter_add = QSTESTCD == "VFQ122" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(source = AVAL, source_range = c(1, 5), target_range = c(0, 100), flip_direction = FALSE),
          PARAMCD = "QR22"
        )
      ),
      params(
        filter_add = QSTESTCD == "VFQ123" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(source = AVAL, source_range = c(1, 5), target_range = c(0, 100), flip_direction = FALSE),
          PARAMCD = "QR23"
        )
      ),
      params(
        filter_add = QSTESTCD == "VFQ124" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(source = AVAL, source_range = c(1, 5), target_range = c(0, 100), flip_direction = FALSE),
          PARAMCD = "QR24"
        )
      ),
      params(
        filter_add = QSTESTCD == "VFQ125" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(source = AVAL, source_range = c(1, 5), target_range = c(0, 100), flip_direction = FALSE),
          PARAMCD = "QR25"
        )
      ),
      params(
        filter_add = QSTESTCD == "VFQ1A01" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(source = AVAL, source_range = c(0, 10), target_range = c(0, 100), flip_direction = FALSE),
          PARAMCD = "QRA01"
        )
      ),
      params(
        filter_add = QSTESTCD == "VFQ1A02" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(source = AVAL, source_range = c(0, 10), target_range = c(0, 100), flip_direction = FALSE),
          PARAMCD = "QRA02"
        )
      ),
      params(
        filter_add = QSTESTCD == "VFQ1A03" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(source = AVAL, source_range = c(1, 5), target_range = c(0, 100), flip_direction = TRUE),
          PARAMCD = "QRA03"
        )
      ),
      params(
        filter_add = QSTESTCD == "VFQ1A04" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(source = AVAL, source_range = c(1, 5), target_range = c(0, 100), flip_direction = TRUE),
          PARAMCD = "QRA04"
        )
      ),
      params(
        filter_add = QSTESTCD == "VFQ1A05" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(source = AVAL, source_range = c(1, 5), target_range = c(0, 100), flip_direction = TRUE),
          PARAMCD = "QRA05"
        )
      ),
      params(
        filter_add = QSTESTCD == "VFQ1A06" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(source = AVAL, source_range = c(1, 5), target_range = c(0, 100), flip_direction = TRUE),
          PARAMCD = "QRA06"
        )
      ),
      params(
        filter_add = QSTESTCD == "VFQ1A07" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(source = AVAL, source_range = c(1, 5), target_range = c(0, 100), flip_direction = TRUE),
          PARAMCD = "QRA07"
        )
      ),
      params(
        filter_add = QSTESTCD == "VFQ1A08" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(source = AVAL, source_range = c(1, 5), target_range = c(0, 100), flip_direction = TRUE),
          PARAMCD = "QRA08"
        )
      ),
      params(
        filter_add = QSTESTCD == "VFQ1A09" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(source = AVAL, source_range = c(1, 5), target_range = c(0, 100), flip_direction = TRUE),
          PARAMCD = "QRA09"
        )
      ),
      params(
        filter_add = QSTESTCD == "VFQ1A11A" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(source = AVAL, source_range = c(1, 5), target_range = c(0, 100), flip_direction = FALSE),
          PARAMCD = "QR1A11A"
        )
      ),
      params(
        filter_add = QSTESTCD == "VFQ1A11B" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(source = AVAL, source_range = c(1, 5), target_range = c(0, 100), flip_direction = FALSE),
          PARAMCD = "QR1A11B"
        )
      ),
      params(
        filter_add = QSTESTCD == "VFQ1A12" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(source = AVAL, source_range = c(1, 5), target_range = c(0, 100), flip_direction = FALSE),
          PARAMCD = "QR1A12"
        )
      ),
      params(
        filter_add = QSTESTCD == "VFQ1A13" & !is.na(AVAL),
        set_values_to = exprs(
          AVAL = compute_scale(source = AVAL, source_range = c(1, 5), target_range = c(0, 100), flip_direction = FALSE),
          PARAMCD = "QR1A13"
        )
      )
    )
  )
```

We can then add the `PARAM` and `PARCATx` variables for both the original and transformed records by merging with the relevant lookup tables.

```{r eval = TRUE}
# Add PARAM, PARCAT vars ----
advfq <- advfq %>%
  derive_vars_merged_lookup(
    dataset_add = rbind(
      param_lookup_original %>% select(-QSTEST, -QSTESTCD),
      param_lookup_transformed
    ),
    by_vars = exprs(PARAMCD)
  )
```

Here's what some of the transformed records look like for one patient's first two visits:

```{r, eval=TRUE, echo=FALSE}
dataset_vignette(
  advfq %>% 
    filter(
      USUBJID %in% c("01-701-1034"), 
      PARAMCD %in% c("VFQ101", "VFQ102", "VFQ119", "QR01", "QR02", "QR19"), 
      AVISIT %in% c("Baseline", "Week 12")
    ) %>% 
    arrange(USUBJID, AVISITN, PARAMCD),
  display_vars = exprs(USUBJID, AVISIT, PARAM, PARAMCD, AVAL)
)
```

## Example Script {#example}

ADaM | Sample Code 
---- | -------------- 
ADVFQ | [ad_advfq.R](https://github.com/pharmaverse/admiralophtha/blob/main/inst/templates/ad_advfq.R)

